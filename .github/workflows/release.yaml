name: Auto Release Static Site

# Запуск только на пуш тегов
on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # 1. Клонируем репозиторий
      - uses: actions/checkout@v3

      # 2. Проверяем, что автор тега — владелец репозитория
      - name: Check tag author
        id: check_author
        run: |
          TAG_NAME="${GITHUB_REF##*/}"
          AUTHOR_LOGIN=$(git for-each-ref refs/tags/$TAG_NAME --format='%(taggername)')
          REPO_OWNER="${GITHUB_REPOSITORY_OWNER}"

          echo "Tag author: $AUTHOR_LOGIN"
          echo "Repo owner: $REPO_OWNER"

          if [ "$AUTHOR_LOGIN" != "$REPO_OWNER" ]; then
            echo "This tag was not created by the repository owner. Exiting."
            exit 0
          fi

      # 3. Копируем все файлы кроме .git
      - name: Prepare release files
        run: |
          mkdir release_temp
          shopt -s extglob
          cp -r !(release_temp|.git) release_temp/
          cd release_temp
          zip -r ../release.zip ./*

      # 4. Создаём релиз
      - name: Create GitHub Release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

      # 5. Загружаем assets
      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          files: release.zip
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
